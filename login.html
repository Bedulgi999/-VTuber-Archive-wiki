<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>로그인 - VTuber Archive Wiki</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./style.css" />
  <style>
    .auth-wrap{max-width:560px;margin:72px auto;padding:0 16px}
    .auth-card{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,14,20,.45);
      box-shadow:0 18px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      padding:22px 18px;
    }
    html[data-theme="light"] .auth-card{
      background:rgba(255,255,255,.72);
      border-color:rgba(0,0,0,.10);
      box-shadow:0 18px 70px rgba(0,0,0,.18);
    }
    .auth-title{font-size:22px;margin:0 0 6px}
    .auth-desc{opacity:.88;margin:0 0 14px}
    .field{display:flex;flex-direction:column;gap:8px;margin:12px 0}
    .field input{
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:inherit; outline:none;
    }
    html[data-theme="light"] .field input{
      background:rgba(255,255,255,.85);
      border-color:rgba(0,0,0,.12);
    }
    .mode{display:flex;gap:14px;align-items:center;margin:10px 0 0;flex-wrap:wrap}
    .mode label{display:flex;gap:8px;align-items:center;cursor:pointer;opacity:.92}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
    .row button{padding:10px 12px;border-radius:14px;cursor:pointer}
    .hint{margin-top:12px;font-size:13px;opacity:.88;line-height:1.45;min-height:18px}
    .mini{font-size:12px;opacity:.75;margin-top:10px}
  </style>
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card">
      <h1 class="auth-title">로그인</h1>
      <p class="auth-desc">비밀번호 또는 매직링크(이메일 링크)로 로그인할 수 있어.</p>

      <form id="authForm">
        <div class="field">
          <label for="email">이메일</label>
          <input id="email" type="email" autocomplete="email" required />
        </div>

        <div class="field" id="pwField">
          <label for="password">비밀번호</label>
          <input id="password" type="password" autocomplete="current-password" />
        </div>

        <div class="mode">
          <label><input type="radio" name="mode" value="password" checked> 비밀번호</label>
          <label><input type="radio" name="mode" value="magic"> 매직링크</label>
        </div>

        <div class="row">
          <button id="submitBtn" type="submit">로그인</button>
          <button id="goHomeBtn" type="button">홈으로</button>
          <button id="themeBtn" type="button">테마</button>
        </div>

        <div class="hint" id="msg"></div>
        <div class="mini">※ file:// 말고 localhost 서버로 열어줘. (python -m http.server)</div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wzbjbiaiumonyvucewqi.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6YmpiaWFpdW1vbnl2dWNld3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDAxMTUsImV4cCI6MjA4NDAxNjExNX0.DFmuUKBRDCDkE5zHF5zH9GLU8Wd-IGFIbLwO-5gJC3o";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        storageKey: "vtwiki-auth-token",
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    const $ = (id)=>document.getElementById(id);
    const msg = (t)=>{ $("msg").textContent = t || ""; };

    $("themeBtn").addEventListener("click", () => {
      const root = document.documentElement;
      root.dataset.theme = root.dataset.theme === "dark" ? "light" : "dark";
    });

    $("goHomeBtn").addEventListener("click", () => location.href = "./index.html");

    document.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        const mode = document.querySelector('input[name="mode"]:checked')?.value;
        $("pwField").style.display = mode === "magic" ? "none" : "block";
      });
    });

    function redirectToHome(){ location.href = "./index.html"; }

    (async ()=>{
      try {
        const { data: { session } } = await sb.auth.getSession();
        if (session?.user) redirectToHome();
      } catch {}
    })();

    let busy = false;
    $("authForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (busy) return;
      busy = true;
      $("submitBtn").disabled = true;
      msg("처리중...");

      const email = $("email").value.trim();
      const password = $("password").value.trim();
      const mode = document.querySelector('input[name="mode"]:checked')?.value || "password";

      try {
        if (mode === "magic") {
          const redirectTo = location.origin + location.pathname.replace(/login\.html.*$/i, "index.html");
          const { error } = await sb.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: redirectTo }
          });
          if (error) throw error;
          msg("매직링크를 이메일로 보냈어. 메일에서 링크를 눌러 로그인해줘.");
          return;
        }

        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;

        msg("로그인 성공! 홈으로 이동중...");
        redirectToHome();
      } catch (err) {
        msg("로그인 실패: " + (err?.message || String(err)));
      } finally {
        busy = false;
        $("submitBtn").disabled = false;
      }
    });

    sb.auth.onAuthStateChange((event, session)=>{
      if (event === "SIGNED_IN" && session?.user) redirectToHome();
    });
  </script>
</body>
</html>
